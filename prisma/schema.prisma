generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  googleId      String    @unique @map("google_id")
  email         String    @unique
  name          String?
  image         String?
  timezone      String    @default("America/New_York")
  planningTime  String    @default("09:00") @map("planning_time")
  energyState   String    @default("neutral") @map("energy_state")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  calendarEvents   CalendarEvent[]
  notifications    Notification[]
  aiInteractions   AIInteraction[]
  pushSubscriptions PushSubscription[]
  preferences      UserPreference?

  @@map("users")
}

model CalendarEvent {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  googleEventId  String   @unique @map("google_event_id")
  title          String
  description    String?
  startTime      DateTime @map("start_time")
  endTime        DateTime @map("end_time")
  status         String   @default("scheduled") // scheduled, completed, cancelled, missed
  difficulty     String   @default("medium") // easy, medium, hard
  taskDetails    Json?    @map("task_details") // {tasks: [], success_criteria: ""}
  snoozeCount    Int      @default(0) @map("snooze_count")
  completionNote String?  @map("completion_note")
  createdAt      DateTime @default(now()) @map("created_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@map("calendar_events")
}

model Notification {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  eventId    String?   @map("event_id")
  type       String    // pre_event, post_event, daily_planning, retro
  message    String?
  sentAt     DateTime  @default(now()) @map("sent_at")
  response   String?   // ready, snooze, reschedule, completed, partial, missed
  responseAt DateTime? @map("response_at")

  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  event CalendarEvent? @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AIInteraction {
  id               String   @id @default(cuid())
  userId           String   @map("user_id")
  model            String   // gpt-4o, gemini-2.5, whisper
  promptTokens     Int      @map("prompt_tokens")
  completionTokens Int      @map("completion_tokens")
  costUsd          Decimal  @map("cost_usd") @db.Decimal(10, 6)
  purpose          String   // planning, accountability, email_draft, transcription
  createdAt        DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_interactions")
}

model PushSubscription {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  endpoint   String
  p256dhKey  String    @map("p256dh_key")
  authKey    String    @map("auth_key")
  deviceName String?   @map("device_name")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@map("push_subscriptions")
}

model UserPreference {
  userId              String @id @map("user_id")
  bookingRules        Json?  @map("booking_rules") // {workHours: {start, end}, bufferMinutes, maxConsecutive}
  communicationStyle  String? @map("communication_style")
  snoozeLimit         Int    @default(2) @map("snooze_limit")
  confidenceThreshold Int    @default(85) @map("confidence_threshold")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}
